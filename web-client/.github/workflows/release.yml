name: Release

on:
  push:
    tags:
      - 'v*'

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: 'registry.hub.docker.com'
  IMAGE_NAME: 'three-kingdoms-web-client'

jobs:
  # åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  create-release:
    runs-on: ubuntu-latest
    name: Create Release
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.3.1
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ğŸ® ä¸‰å›½å¡ç‰Œæ¸¸æˆ ${{ github.ref_name }}

            ### ğŸ“ æ›´æ–°å†…å®¹
            ${{ steps.changelog.outputs.changelog }}

            ### ğŸš€ éƒ¨ç½²ä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤SHA: ${{ github.sha }}
            - å‘å¸ƒåˆ†æ”¯: ${{ github.ref_name }}

            ### ğŸ“¦ èµ„æºä¸‹è½½
            - [æºä»£ç ](https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.zip)
            - [Dockeré•œåƒ](https://hub.docker.com/r/${{ env.IMAGE_NAME }})

            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - React 19.1.0
            - TypeScript 5.8.3
            - Vite 7.0.0
            - Redux Toolkit 2.8.2
            - Tailwind CSS 4.1.11

            ### ğŸ“± æ”¯æŒå¹³å°
            - ç°ä»£æµè§ˆå™¨ (Chrome, Firefox, Safari, Edge)
            - ç§»åŠ¨ç«¯æµè§ˆå™¨
            - PWAæ”¯æŒ

            ---
            ğŸ¤– æ­¤å‘å¸ƒç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
          draft: false
          prerelease: false

  # æ„å»ºå‘å¸ƒèµ„æº
  build-release:
    runs-on: ubuntu-latest
    name: Build Release Assets
    needs: create-release

    strategy:
      matrix:
        include:
          - name: 'web-client'
            build_command: 'npm run build:prod'
            artifact_path: 'dist'
            zip_name: 'three-kingdoms-web-client'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Optimize images
        run: npm run optimize-images

      - name: Build ${{ matrix.name }}
        run: ${{ matrix.build_command }}
        env:
          NODE_ENV: production
          CI: true
          VITE_APP_VERSION: ${{ github.ref_name }}
          VITE_BUILD_DATE: ${{ github.event.head_commit.timestamp }}

      - name: Create deployment package
        run: |
          cd ${{ matrix.artifact_path }}
          zip -r ../${{ matrix.zip_name }}-${{ github.ref_name }}.zip .
          cd ..

          # åˆ›å»º Docker Compose éƒ¨ç½²åŒ…
          mkdir -p deploy
          cp docker-compose.yml deploy/
          cp nginx.conf deploy/
          cp nginx.default.conf deploy/
          cp docker-entrypoint.sh deploy/
          cp scripts/docker-run.sh deploy/

          # åˆ›å»ºéƒ¨ç½²è¯´æ˜
          cat > deploy/README.md << 'EOF'
          # ä¸‰å›½å¡ç‰Œæ¸¸æˆéƒ¨ç½²åŒ…

          ## å¿«é€Ÿéƒ¨ç½²

          1. è§£å‹éƒ¨ç½²åŒ…
          2. è¿è¡Œ: `docker-compose up -d`
          3. è®¿é—®: http://localhost:8080

          ## é…ç½®è¯´æ˜

          - ä¿®æ”¹ docker-compose.yml ä¸­çš„ç¯å¢ƒå˜é‡
          - é…ç½® nginx.conf è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®

          ## å‘½ä»¤è¯´æ˜

          ```bash
          # å¯åŠ¨æœåŠ¡
          docker-compose up -d

          # æŸ¥çœ‹æ—¥å¿—
          docker-compose logs -f

          # åœæ­¢æœåŠ¡
          docker-compose down

          # æ›´æ–°é•œåƒ
          docker-compose pull && docker-compose up -d
          ```
          EOF

          zip -r deploy-${{ github.ref_name }}.zip deploy/

      - name: Generate build info
        run: |
          cat > build-info.json << EOF
          {
            "version": "${{ github.ref_name }}",
            "buildDate": "${{ github.event.head_commit.timestamp }}",
            "commitSha": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "nodeVersion": "${{ env.NODE_VERSION }}",
            "buildEnvironment": "GitHub Actions",
            "artifacts": {
              "webClient": "${{ matrix.zip_name }}-${{ github.ref_name }}.zip",
              "deployment": "deploy-${{ github.ref_name }}.zip"
            }
          }
          EOF

      - name: Upload web client package
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./${{ matrix.zip_name }}-${{ github.ref_name }}.zip
          asset_name: ${{ matrix.zip_name }}-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload deployment package
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./deploy-${{ github.ref_name }}.zip
          asset_name: deploy-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload build info
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./build-info.json
          asset_name: build-info.json
          asset_content_type: application/json

  # Dockerå‘å¸ƒ
  docker-release:
    runs-on: ubuntu-latest
    name: Docker Release
    needs: create-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major_minor=$(echo $VERSION | cut -d. -f1-2)" >> $GITHUB_OUTPUT
          echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.major_minor }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.major }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            APP_VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ env.IMAGE_NAME }}
          short-description: 'ä¸‰å›½å¡ç‰Œæ¸¸æˆ Web å®¢æˆ·ç«¯'
          readme-filepath: ./README.md

  # é€šçŸ¥å‘å¸ƒå®Œæˆ
  notify-release:
    runs-on: ubuntu-latest
    name: Notify Release
    needs: [build-release, docker-release]
    if: always()

    steps:
      - name: Notify Slack on success
        if: needs.build-release.result == 'success' && needs.docker-release.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒæˆåŠŸï¼

            ğŸ“¦ ç‰ˆæœ¬: ${{ github.ref_name }}
            ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
            ğŸ³ Dockeré•œåƒ: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

            âœ… æ‰€æœ‰æ„å»ºå’Œæµ‹è¯•é€šè¿‡
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: needs.build-release.result == 'failure' || needs.docker-release.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ ç‰ˆæœ¬å‘å¸ƒå¤±è´¥ï¼

            ğŸ“¦ ç‰ˆæœ¬: ${{ github.ref_name }}
            ğŸ”— æ„å»ºæ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶é‡æ–°å‘å¸ƒ
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create deployment issue
        if: needs.build-release.result == 'success' && needs.docker-release.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `éƒ¨ç½² ${context.payload.ref} åˆ°ç”Ÿäº§ç¯å¢ƒ`,
              body: `
              ## ğŸš€ éƒ¨ç½²æ¸…å•

              **ç‰ˆæœ¬ä¿¡æ¯**
              - ç‰ˆæœ¬å·: ${context.payload.ref}
              - å‘å¸ƒæ—¶é—´: ${new Date().toISOString()}
              - æ„å»ºID: ${context.runId}

              **éƒ¨ç½²æ­¥éª¤**
              - [ ] æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒçŠ¶æ€
              - [ ] å¤‡ä»½å½“å‰ç‰ˆæœ¬
              - [ ] éƒ¨ç½²æ–°ç‰ˆæœ¬
              - [ ] éªŒè¯åŠŸèƒ½æ­£å¸¸
              - [ ] ç›‘æ§ç³»ç»ŸæŒ‡æ ‡
              - [ ] é€šçŸ¥ç”¨æˆ·æ›´æ–°

              **å›æ»šè®¡åˆ’**
              å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬

              **ç›¸å…³é“¾æ¥**
              - [å‘å¸ƒé¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${context.payload.ref})
              - [Dockeré•œåƒ](https://${process.env.DOCKER_REGISTRY}/${process.env.IMAGE_NAME}:${context.payload.ref})
              `,
              labels: ['deployment', 'production']
            });
