name: Scheduled Tasks

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä¾èµ–æ£€æŸ¥
    - cron: '0 2 * * *'
    # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 3 * * 1'
    # æ¯æœˆ1å·å‡Œæ™¨4ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
    - cron: '0 4 1 * *'
  workflow_dispatch:
    inputs:
      task_type:
        description: 'é€‰æ‹©è¦è¿è¡Œçš„ä»»åŠ¡'
        required: true
        default: 'dependency-check'
        type: choice
        options:
          - dependency-check
          - security-audit
          - performance-test
          - cleanup

env:
  NODE_VERSION: '18'

jobs:
  # ä¾èµ–æ£€æŸ¥
  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Check
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task_type == 'dependency-check'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Check for outdated dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm outdated --json > outdated-deps.json || true
          cat outdated-deps.json

      - name: Check for vulnerable dependencies
        run: |
          npm audit --json > audit-results.json || true
          cat audit-results.json

      - name: Generate dependency report
        run: |
          cat > dependency-report.md << 'EOF'
          # ä¾èµ–æ£€æŸ¥æŠ¥å‘Š

          ç”Ÿæˆæ—¶é—´: $(date)

          ## è¿‡æ—¶çš„ä¾èµ–
          ```json
          $(cat outdated-deps.json)
          ```

          ## å®‰å…¨æ¼æ´ž
          ```json
          $(cat audit-results.json)
          ```

          ## å»ºè®®
          - å®šæœŸæ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬
          - åŠæ—¶ä¿®å¤å®‰å…¨æ¼æ´ž
          - å…³æ³¨ä¾èµ–çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
          EOF

      - name: Create issue for outdated dependencies
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const outdated = JSON.parse(fs.readFileSync('outdated-deps.json', 'utf8'));
              const audit = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              
              if (Object.keys(outdated).length > 0 || audit.metadata?.vulnerabilities?.total > 0) {
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: 'dependencies,scheduled',
                  state: 'open'
                });
                
                const existingIssue = issues.data.find(issue => 
                  issue.title.includes('ä¾èµ–æ›´æ–°æé†’')
                );
                
                const issueBody = `
                ## ðŸ“¦ ä¾èµ–æ£€æŸ¥æŠ¥å‘Š
                
                **æ£€æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
                
                ### è¿‡æ—¶çš„ä¾èµ–åŒ…
                ${Object.keys(outdated).length > 0 ? 
                  Object.entries(outdated).map(([pkg, info]) => 
                    `- **${pkg}**: ${info.current} â†’ ${info.wanted} (latest: ${info.latest})`
                  ).join('\n') : 
                  'âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬'
                }
                
                ### å®‰å…¨æ¼æ´ž
                ${audit.metadata?.vulnerabilities?.total > 0 ?
                  `âš ï¸ å‘çŽ° ${audit.metadata.vulnerabilities.total} ä¸ªå®‰å…¨æ¼æ´ž` :
                  'âœ… æœªå‘çŽ°å®‰å…¨æ¼æ´ž'
                }
                
                ### å»ºè®®æ“ä½œ
                - [ ] æ£€æŸ¥å¹¶æ›´æ–°è¿‡æ—¶çš„ä¾èµ–
                - [ ] ä¿®å¤å®‰å…¨æ¼æ´ž
                - [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿æ›´æ–°åŽåŠŸèƒ½æ­£å¸¸
                
                ---
                ðŸ¤– æ­¤æŠ¥å‘Šç”±å®šæ—¶ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ
                `;
                
                if (existingIssue) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: existingIssue.number,
                    body: issueBody
                  });
                } else {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `ðŸ“¦ ä¾èµ–æ›´æ–°æé†’ - ${new Date().toLocaleDateString('zh-CN')}`,
                    body: issueBody,
                    labels: ['dependencies', 'scheduled', 'maintenance']
                  });
                }
              }
            } catch (error) {
              console.log('Error processing dependency check:', error);
            }

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            outdated-deps.json
            audit-results.json
            dependency-report.md
          retention-days: 30

  # å®‰å…¨å®¡è®¡
  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit
    if: github.event.schedule == '0 3 * * 1' || github.event.inputs.task_type == 'security-audit'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true

      - name: Run CodeQL analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --json > snyk-results.json
        continue-on-error: true

      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'

      - name: Generate security report
        run: |
          cat > security-report.md << 'EOF'
          # å®‰å…¨å®¡è®¡æŠ¥å‘Š

          ç”Ÿæˆæ—¶é—´: $(date)

          ## NPMå®¡è®¡ç»“æžœ
          ```json
          $(cat npm-audit.json)
          ```

          ## Trivyæ‰«æç»“æžœ
          ```json
          $(cat trivy-results.json)
          ```

          ## å»ºè®®
          - åŠæ—¶æ›´æ–°æœ‰å®‰å…¨æ¼æ´žçš„ä¾èµ–
          - å¯ç”¨è‡ªåŠ¨å®‰å…¨æ›´æ–°
          - å®šæœŸè¿›è¡Œå®‰å…¨ä»£ç å®¡æŸ¥
          EOF

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            npm-audit.json
            snyk-results.json
            trivy-results.json
            security-report.md
          retention-days: 90

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    name: Performance Test
    if: github.event.schedule == '0 4 1 * *' || github.event.inputs.task_type == 'performance-test'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start preview server
        run: |
          npm run preview &
          sleep 10

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=.lighthouserc.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Bundle size analysis
        run: |
          npm install -g webpack-bundle-analyzer
          npx webpack-bundle-analyzer dist/assets/*.js --report --mode json --report-filename bundle-analysis.json

      - name: Generate performance report
        run: |
          cat > performance-report.md << 'EOF'
          # æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

          ç”Ÿæˆæ—¶é—´: $(date)

          ## Lighthouseè¯„åˆ†
          [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Bundleå¤§å°åˆ†æž
          ```json
          $(cat bundle-analysis.json)
          ```

          ## å»ºè®®
          - ä¼˜åŒ–å›¾ç‰‡èµ„æº
          - ä»£ç åˆ†å‰²ä¼˜åŒ–
          - ç¼“å­˜ç­–ç•¥æ”¹è¿›
          EOF

      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-reports
          path: |
            .lighthouseci/
            bundle-analysis.json
            performance-report.md
          retention-days: 90

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    runs-on: ubuntu-latest
    name: Cleanup Old Artifacts
    if: github.event.inputs.task_type == 'cleanup'

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              per_page: 100
            });

            // ä¿ç•™æœ€æ–°çš„30ä¸ªè¿è¡Œè®°å½•ï¼Œåˆ é™¤å…¶ä½™çš„
            const runsToDelete = runs.workflow_runs.slice(30);

            for (const run of runsToDelete) {
              if (run.status === 'completed') {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  console.log(`Deleted workflow run ${run.id}`);
                } catch (error) {
                  console.log(`Failed to delete workflow run ${run.id}: ${error.message}`);
                }
              }
            }

      - name: Clean Docker registry
        run: |
          echo "æ¸…ç†Dockeré•œåƒ..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†Dockeré•œåƒçš„è„šæœ¬

  # é€šçŸ¥
  notify-results:
    runs-on: ubuntu-latest
    name: Notify Results
    needs: [dependency-check, security-audit, performance-test]
    if: always()

    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸ“Š å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆ

            ðŸ” ä¾èµ–æ£€æŸ¥: ${{ needs.dependency-check.result || 'skipped' }}
            ðŸ”’ å®‰å…¨å®¡è®¡: ${{ needs.security-audit.result || 'skipped' }}
            âš¡ æ€§èƒ½æµ‹è¯•: ${{ needs.performance-test.result || 'skipped' }}

            ðŸ“… æ‰§è¡Œæ—¶é—´: $(date)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
