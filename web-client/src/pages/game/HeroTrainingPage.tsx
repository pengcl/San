import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useDispatch } from 'react-redux';
import { addNotification } from '../../store/slices/uiSlice';
import { useAnalytics } from '../../hooks/useAnalytics';
import GameCard from '../../components/ui/GameCard';
import Button from '../../components/ui/Button';
import HealthBar from '../../components/ui/HealthBar';
import CountdownTimer from '../../components/ui/CountdownTimer';
import type { Hero } from '../../types';

interface TrainingOption {
  id: string;
  name: string;
  description: string;
  cost: {
    gold?: number;
    gems?: number;
    items?: Array<{ id: string; name: string; count: number }>;
  };
  duration: number; // Áßí
  rewards: {
    experience: number;
    stats?: {
      attack?: number;
      defense?: number;
      health?: number;
      speed?: number;
    };
  };
  unlockLevel: number;
  icon: string;
}

interface TrainingSession {
  heroId: number;
  trainingId: string;
  startTime: number;
  endTime: number;
  rewards: TrainingOption['rewards'];
}

const HeroTrainingPage: React.FC = () => {
  const { heroId } = useParams<{ heroId: string }>();
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const { trackGameEvent } = useAnalytics();
  
  const [hero, setHero] = useState<Hero | null>(null);
  const [selectedTraining, setSelectedTraining] = useState<TrainingOption | null>(null);
  const [currentSession, setCurrentSession] = useState<TrainingSession | null>(null);
  const [playerResources, setPlayerResources] = useState({
    gold: 50000,
    gems: 1200,
    items: [
      { id: 'training_manual', name: 'ËÆ≠ÁªÉÊâãÂÜå', count: 15 },
      { id: 'weapon_stone', name: 'Ê≠¶Âô®Âº∫ÂåñÁü≥', count: 8 },
      { id: 'armor_stone', name: 'Èò≤ÂÖ∑Âº∫ÂåñÁü≥', count: 12 },
    ]
  });

  const trainingOptions: TrainingOption[] = [
    {
      id: 'basic_combat',
      name: 'Âü∫Á°ÄÊàòÊñóËÆ≠ÁªÉ',
      description: 'ÊèêÂçáÊ≠¶Â∞ÜÂü∫Á°ÄÊàòÊñóÁªèÈ™åÂíåÊîªÂáªÂäõ',
      cost: { gold: 1000 },
      duration: 300, // 5ÂàÜÈíüÔºàÊºîÁ§∫Áî®Ôºâ
      rewards: {
        experience: 500,
        stats: { attack: 5 }
      },
      unlockLevel: 1,
      icon: '‚öîÔ∏è'
    },
    {
      id: 'defense_training',
      name: 'Èò≤Âæ°ÊäÄÂ∑ßËÆ≠ÁªÉ',
      description: 'Âº∫ÂåñÊ≠¶Â∞ÜÁöÑÈò≤Âæ°ËÉΩÂäõÂíåË°ÄÈáè',
      cost: { gold: 1500 },
      duration: 450,
      rewards: {
        experience: 600,
        stats: { defense: 8, health: 50 }
      },
      unlockLevel: 5,
      icon: 'üõ°Ô∏è'
    },
    {
      id: 'speed_training',
      name: 'ÊïèÊç∑ÈÄüÂ∫¶ËÆ≠ÁªÉ',
      description: 'ÊèêÂçáÊ≠¶Â∞ÜÁöÑË°åÂä®ÈÄüÂ∫¶ÂíåÈó™ÈÅøËÉΩÂäõ',
      cost: { gold: 1200 },
      duration: 360,
      rewards: {
        experience: 450,
        stats: { speed: 10 }
      },
      unlockLevel: 8,
      icon: 'üèÉ'
    },
    {
      id: 'advanced_combat',
      name: 'È´òÁ∫ßÊàòÊñóËÆ≠ÁªÉ',
      description: 'ÂÖ®Èù¢ÊèêÂçáÊ≠¶Â∞ÜÁöÑÊàòÊñóÊäÄËÉΩ',
      cost: { 
        gold: 3000,
        items: [{ id: 'training_manual', name: 'ËÆ≠ÁªÉÊâãÂÜå', count: 2 }]
      },
      duration: 900,
      rewards: {
        experience: 1200,
        stats: { attack: 12, defense: 8, speed: 5 }
      },
      unlockLevel: 15,
      icon: 'üéØ'
    },
    {
      id: 'elite_training',
      name: 'Á≤æËã±ÁâπËÆ≠',
      description: 'ÊúÄÈ´òÁ∫ßÁöÑËÆ≠ÁªÉËØæÁ®ãÔºåÂ§ßÂπÖÊèêÂçáÊâÄÊúâÂ±ûÊÄß',
      cost: { 
        gems: 50,
        items: [
          { id: 'weapon_stone', name: 'Ê≠¶Âô®Âº∫ÂåñÁü≥', count: 1 },
          { id: 'armor_stone', name: 'Èò≤ÂÖ∑Âº∫ÂåñÁü≥', count: 1 }
        ]
      },
      duration: 1800,
      rewards: {
        experience: 2000,
        stats: { attack: 20, defense: 15, health: 100, speed: 8 }
      },
      unlockLevel: 25,
      icon: 'üëë'
    }
  ];

  useEffect(() => {
    trackGameEvent('hero_training_view', { heroId });
    
    // Ê®°ÊãüÂä†ËΩΩÊ≠¶Â∞ÜÊï∞ÊçÆ
    const mockHero: Hero = {
      id: parseInt(heroId || '1'),
      name: 'Ëµµ‰∫ë',
      title: 'Â∏∏ËÉúÂ∞ÜÂÜõ',
      description: 'Ëµµ‰∫ëÔºåÂ≠óÂ≠êÈæôÔºåÂ∏∏Â±±ÁúüÂÆö‰∫∫Ôºå‰∏âÂõΩÊó∂ÊúüËúÄÊ±âÂêçÂ∞Ü„ÄÇ',
      level: 18,
      experience: 3250,
      rarity: 5,
      faction: 'ËúÄ',
      role: 'Áâ©ÁêÜËæìÂá∫',
      unit_type: 'È™ëÂÖµ',
      cost: 6,
      health: 1850,
      attack: 285,
      defense: 180,
      speed: 95,
      energy: 100,
      skills: [],
      equipment: [],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    };
    setHero(mockHero);

    // Ê£ÄÊü•ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑËÆ≠ÁªÉ
    const savedSession = localStorage.getItem(`training_${heroId}`);
    if (savedSession) {
      const session: TrainingSession = JSON.parse(savedSession);
      if (session.endTime > Date.now()) {
        setCurrentSession(session);
      } else {
        // ËÆ≠ÁªÉÂ∑≤ÂÆåÊàêÔºåÊ∏ÖÁêÜÂ≠òÂÇ®
        localStorage.removeItem(`training_${heroId}`);
      }
    }
  }, [heroId, trackGameEvent]);

  const canAfford = (cost: TrainingOption['cost']): boolean => {
    if (cost.gold && playerResources.gold < cost.gold) return false;
    if (cost.gems && playerResources.gems < cost.gems) return false;
    if (cost.items) {
      for (const item of cost.items) {
        const playerItem = playerResources.items.find(i => i.id === item.id);
        if (!playerItem || playerItem.count < item.count) return false;
      }
    }
    return true;
  };

  const startTraining = (training: TrainingOption) => {
    if (!hero || !canAfford(training.cost)) return;

    const startTime = Date.now();
    const endTime = startTime + (training.duration * 1000);
    
    const session: TrainingSession = {
      heroId: hero.id,
      trainingId: training.id,
      startTime,
      endTime,
      rewards: training.rewards
    };

    // Êâ£Èô§ËµÑÊ∫ê
    setPlayerResources(prev => {
      const newResources = { ...prev };
      if (training.cost.gold) newResources.gold -= training.cost.gold;
      if (training.cost.gems) newResources.gems -= training.cost.gems;
      if (training.cost.items) {
        newResources.items = newResources.items.map(item => {
          const costItem = training.cost.items?.find(i => i.id === item.id);
          if (costItem) {
            return { ...item, count: item.count - costItem.count };
          }
          return item;
        });
      }
      return newResources;
    });

    setCurrentSession(session);
    localStorage.setItem(`training_${heroId}`, JSON.stringify(session));
    
    trackGameEvent('hero_training_start', {
      heroId: hero.id,
      trainingId: training.id,
      duration: training.duration
    });

    dispatch(
      addNotification({
        type: 'success',
        title: 'ËÆ≠ÁªÉÂºÄÂßã',
        message: `${hero.name} ÂºÄÂßã‰∫Ü ${training.name}`,
        duration: 3000,
      })
    );

    setSelectedTraining(null);
  };

  const completeTraining = () => {
    if (!currentSession || !hero) return;

    // Â∫îÁî®Â•ñÂä±
    setHero(prev => {
      if (!prev) return prev;
      const newHero = { ...prev };
      newHero.experience += currentSession.rewards.experience;
      
      if (currentSession.rewards.stats) {
        if (currentSession.rewards.stats.attack) {
          newHero.attack += currentSession.rewards.stats.attack;
        }
        if (currentSession.rewards.stats.defense) {
          newHero.defense += currentSession.rewards.stats.defense;
        }
        if (currentSession.rewards.stats.health) {
          newHero.health += currentSession.rewards.stats.health;
        }
        if (currentSession.rewards.stats.speed) {
          newHero.speed += currentSession.rewards.stats.speed;
        }
      }
      
      return newHero;
    });

    trackGameEvent('hero_training_complete', {
      heroId: hero.id,
      trainingId: currentSession.trainingId,
      experience_gained: currentSession.rewards.experience
    });

    dispatch(
      addNotification({
        type: 'success',
        title: 'ËÆ≠ÁªÉÂÆåÊàê',
        message: `${hero.name} ÂÆåÊàê‰∫ÜËÆ≠ÁªÉÔºåËé∑Âæó ${currentSession.rewards.experience} ÁªèÈ™åÂÄºÔºÅ`,
        duration: 5000,
      })
    );

    localStorage.removeItem(`training_${heroId}`);
    setCurrentSession(null);
  };

  const cancelTraining = () => {
    if (!currentSession) return;

    trackGameEvent('hero_training_cancel', {
      heroId: hero?.id,
      trainingId: currentSession.trainingId
    });

    localStorage.removeItem(`training_${heroId}`);
    setCurrentSession(null);

    dispatch(
      addNotification({
        type: 'info',
        title: 'ËÆ≠ÁªÉÂèñÊ∂à',
        message: 'ËÆ≠ÁªÉÂ∑≤ÂèñÊ∂àÔºåËµÑÊ∫ê‰∏ç‰ºöÈÄÄËøò',
        duration: 3000,
      })
    );
  };

  const renderCost = (cost: TrainingOption['cost']) => {
    const items = [];
    
    if (cost.gold) {
      items.push(
        <span key="gold" className="flex items-center space-x-1">
          <span className="text-yellow-400">üí∞</span>
          <span>{cost.gold.toLocaleString()}</span>
        </span>
      );
    }
    
    if (cost.gems) {
      items.push(
        <span key="gems" className="flex items-center space-x-1">
          <span className="text-blue-400">üíé</span>
          <span>{cost.gems}</span>
        </span>
      );
    }
    
    if (cost.items) {
      cost.items.forEach(item => {
        items.push(
          <span key={item.id} className="flex items-center space-x-1">
            <span className="text-purple-400">üì¶</span>
            <span>{item.name} x{item.count}</span>
          </span>
        );
      });
    }

    return (
      <div className="flex flex-wrap gap-2 text-sm">
        {items}
      </div>
    );
  };

  if (!hero) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="text-4xl mb-4">‚è≥</div>
          <p className="text-gray-400">Âä†ËΩΩÊ≠¶Â∞Ü‰ø°ÊÅØ‰∏≠...</p>
        </div>
      </div>
    );
  }

  return (
    <motion.div
      className="space-y-6 particle-bg"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.5 }}
    >
      {/* ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò */}
      <div className="flex items-center space-x-4">
        <Button
          variant="secondary"
          onClick={() => navigate(-1)}
          className="flex items-center space-x-2"
        >
          <span>‚Üê</span>
          <span>ËøîÂõû</span>
        </Button>
        <div>
          <h1 className="text-3xl font-bold text-game-title text-shadow-glow font-game">
            Ê≠¶Â∞ÜÂüπÂÖª
          </h1>
          <p className="text-gray-400 text-shadow">
            {hero.name} - {hero.title}
          </p>
        </div>
      </div>

      {/* Ê≠¶Â∞Ü‰ø°ÊÅØÈù¢Êùø */}
      <GameCard className="p-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Ê≠¶Â∞ÜÂü∫Êú¨‰ø°ÊÅØ */}
          <div className="space-y-4">
            <div className="flex items-center space-x-4">
              <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center text-2xl font-bold text-white shadow-lg">
                {hero.name[0]}
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">{hero.name}</h3>
                <p className="text-orange-400">{hero.title}</p>
                <p className="text-sm text-gray-400">Á≠âÁ∫ß {hero.level} | {hero.faction}ÂõΩ</p>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex justify-between items-center">
                <span className="text-gray-400">ÁªèÈ™åÂÄº</span>
                <span className="text-white">{hero.experience.toLocaleString()}</span>
              </div>
              <HealthBar 
                current={hero.experience % 1000} 
                max={1000} 
                color="experience"
                className="h-2"
              />
            </div>
          </div>

          {/* Ê≠¶Â∞ÜÂ±ûÊÄß */}
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-gray-800 rounded-lg p-3">
              <div className="text-red-400 text-sm">ÊîªÂáªÂäõ</div>
              <div className="text-xl font-bold text-white">{hero.attack}</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-3">
              <div className="text-blue-400 text-sm">Èò≤Âæ°Âäõ</div>
              <div className="text-xl font-bold text-white">{hero.defense}</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-3">
              <div className="text-green-400 text-sm">ÁîüÂëΩÂÄº</div>
              <div className="text-xl font-bold text-white">{hero.health}</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-3">
              <div className="text-yellow-400 text-sm">ÈÄüÂ∫¶</div>
              <div className="text-xl font-bold text-white">{hero.speed}</div>
            </div>
          </div>
        </div>
      </GameCard>

      {/* ÂΩìÂâçËÆ≠ÁªÉÁä∂ÊÄÅ */}
      <AnimatePresence>
        {currentSession && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
          >
            <GameCard className="p-6 border-2 border-orange-500 bg-gradient-to-r from-orange-900/20 to-red-900/20">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <div className="text-3xl">üèÉ‚Äç‚ôÇÔ∏è</div>
                  <div>
                    <h3 className="text-lg font-bold text-white">ËÆ≠ÁªÉËøõË°å‰∏≠</h3>
                    <p className="text-orange-400">
                      {trainingOptions.find(t => t.id === currentSession.trainingId)?.name}
                    </p>
                  </div>
                </div>
                
                <div className="text-right">
                  <CountdownTimer
                    endTime={currentSession.endTime}
                    onComplete={completeTraining}
                    className="text-xl font-bold text-orange-400"
                  />
                  <Button
                    variant="danger"
                    size="sm"
                    onClick={cancelTraining}
                    className="mt-2"
                  >
                    ÂèñÊ∂àËÆ≠ÁªÉ
                  </Button>
                </div>
              </div>
              
              <div className="mt-4">
                <div className="text-sm text-gray-400 mb-2">ËÆ≠ÁªÉËøõÂ∫¶</div>
                <HealthBar
                  current={Date.now() - currentSession.startTime}
                  max={currentSession.endTime - currentSession.startTime}
                  color="orange"
                  className="h-3"
                />
              </div>
            </GameCard>
          </motion.div>
        )}
      </AnimatePresence>

      {/* ËµÑÊ∫êÊòæÁ§∫ */}
      <GameCard className="p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-white">ÊàëÁöÑËµÑÊ∫ê</h3>
          <div className="flex items-center space-x-6">
            <div className="flex items-center space-x-2">
              <span className="text-yellow-400">üí∞</span>
              <span className="text-white">{playerResources.gold.toLocaleString()}</span>
            </div>
            <div className="flex items-center space-x-2">
              <span className="text-blue-400">üíé</span>
              <span className="text-white">{playerResources.gems}</span>
            </div>
            {playerResources.items.map(item => (
              <div key={item.id} className="flex items-center space-x-2">
                <span className="text-purple-400">üì¶</span>
                <span className="text-white text-sm">{item.name}: {item.count}</span>
              </div>
            ))}
          </div>
        </div>
      </GameCard>

      {/* ËÆ≠ÁªÉÈÄâÈ°π */}
      {!currentSession && (
        <div className="space-y-4">
          <h2 className="text-2xl font-bold text-game-title">ÈÄâÊã©ËÆ≠ÁªÉËØæÁ®ã</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {trainingOptions.map((training, index) => {
              const isUnlocked = hero.level >= training.unlockLevel;
              const canAffordTraining = canAfford(training.cost);
              
              return (
                <motion.div
                  key={training.id}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.1 }}
                >
                  <GameCard 
                    className={`p-6 cursor-pointer transition-all ${
                      isUnlocked 
                        ? canAffordTraining
                          ? 'hover:shadow-lg hover:shadow-orange-500/20 border-transparent hover:border-orange-500'
                          : 'opacity-60'
                        : 'opacity-40'
                    }`}
                    onClick={() => {
                      if (isUnlocked && canAffordTraining) {
                        setSelectedTraining(training);
                      }
                    }}
                  >
                    <div className="text-center mb-4">
                      <div className="text-3xl mb-2">{training.icon}</div>
                      <h3 className="text-lg font-bold text-white">{training.name}</h3>
                      {!isUnlocked && (
                        <p className="text-red-400 text-sm">ÈúÄË¶ÅÁ≠âÁ∫ß {training.unlockLevel}</p>
                      )}
                    </div>
                    
                    <p className="text-gray-400 text-sm mb-4 line-clamp-2">
                      {training.description}
                    </p>
                    
                    <div className="space-y-3">
                      <div>
                        <div className="text-xs text-gray-500 mb-1">Ê∂àËÄó</div>
                        {renderCost(training.cost)}
                      </div>
                      
                      <div>
                        <div className="text-xs text-gray-500 mb-1">Êó∂Èïø</div>
                        <div className="text-sm text-white">
                          {Math.floor(training.duration / 60)}ÂàÜ{training.duration % 60}Áßí
                        </div>
                      </div>
                      
                      <div>
                        <div className="text-xs text-gray-500 mb-1">Â•ñÂä±</div>
                        <div className="text-sm text-green-400">
                          +{training.rewards.experience} ÁªèÈ™åÂÄº
                        </div>
                        {training.rewards.stats && (
                          <div className="text-xs text-blue-400">
                            {Object.entries(training.rewards.stats).map(([stat, value]) => (
                              <span key={stat} className="mr-2">
                                +{value} {stat === 'attack' ? 'ÊîªÂáª' : stat === 'defense' ? 'Èò≤Âæ°' : stat === 'health' ? 'ÁîüÂëΩ' : 'ÈÄüÂ∫¶'}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </GameCard>
                </motion.div>
              );
            })}
          </div>
        </div>
      )}

      {/* Á°ÆËÆ§ËÆ≠ÁªÉÂØπËØùÊ°Ü */}
      <AnimatePresence>
        {selectedTraining && (
          <motion.div
            className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={() => setSelectedTraining(null)}
          >
            <motion.div
              className="bg-gray-800 rounded-lg p-6 max-w-md w-full border border-gray-700"
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              onClick={e => e.stopPropagation()}
            >
              <div className="text-center mb-6">
                <div className="text-4xl mb-2">{selectedTraining.icon}</div>
                <h3 className="text-xl font-bold text-white">{selectedTraining.name}</h3>
                <p className="text-gray-400 mt-2">{selectedTraining.description}</p>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <div className="text-sm text-gray-400 mb-2">Ê∂àËÄóËµÑÊ∫ê</div>
                  {renderCost(selectedTraining.cost)}
                </div>
                
                <div>
                  <div className="text-sm text-gray-400 mb-2">ËÆ≠ÁªÉÊó∂Èïø</div>
                  <div className="text-white">
                    {Math.floor(selectedTraining.duration / 60)}ÂàÜ{selectedTraining.duration % 60}Áßí
                  </div>
                </div>
                
                <div>
                  <div className="text-sm text-gray-400 mb-2">Ëé∑ÂæóÂ•ñÂä±</div>
                  <div className="text-green-400">+{selectedTraining.rewards.experience} ÁªèÈ™åÂÄº</div>
                  {selectedTraining.rewards.stats && (
                    <div className="text-blue-400 text-sm">
                      {Object.entries(selectedTraining.rewards.stats).map(([stat, value]) => (
                        <div key={stat}>
                          +{value} {stat === 'attack' ? 'ÊîªÂáªÂäõ' : stat === 'defense' ? 'Èò≤Âæ°Âäõ' : stat === 'health' ? 'ÁîüÂëΩÂÄº' : 'ÈÄüÂ∫¶'}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <div className="flex space-x-3">
                <Button
                  variant="secondary"
                  className="flex-1"
                  onClick={() => setSelectedTraining(null)}
                >
                  ÂèñÊ∂à
                </Button>
                <Button
                  variant="primary"
                  className="flex-1"
                  onClick={() => startTraining(selectedTraining)}
                >
                  ÂºÄÂßãËÆ≠ÁªÉ
                </Button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

export default HeroTrainingPage;